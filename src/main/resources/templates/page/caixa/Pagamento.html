<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{principal}">
<head>
  <title th:text="#{mercadinho}"></title>
</head>

  <section layout:fragment="container">
    <div id="conteudo">
      <form id="caixaForm" role="form"  method="POST" th:action="@{/caixa}" th:object="${venda}">
        <!-- <header layout:insert="~{cabecalho}"></header> -->
        <div class="pt-2"></div>
        <!-- <header layout:insert="~{corpo}"></header> -->
        <section class="content">
          <div class="container-fluid">
            <div layout:insert="~{mensagem_geral}"></div>
            <div layout:insert="~{mensagem_erro}"></div>
            
            <div class="row">
              <div class="col-md-12">
                <div class="card card-default">
                  <!-- <div class="card-header"></div> -->
                  <div class="card-body">
                    <input type="hidden" th:field="*{id}"></input>
                    <input type="hidden" th:field="*{dataVenda}"></input>
                    <!-- <input type="hidden" th:field="*{itemList}"></input> -->
                    <input type="hidden" th:field="*{status}"></input>
                    <input type="hidden" th:field="*{subtotal}"></input>
                    <input type="hidden" th:field="*{total}"></input>
                    <input type="hidden" th:field="*{valorDesconto}"></input>
                    
                    <div class="row" >
                      <div class="col-6">
                        <div class="table-responsive">
                          <table class="table">
                            <tr>
                              <th class="lead mt-2" style="width:50%">Subtotal:</th>
                              <td id="subtotal" class="js-subtotal"><h3 class="mb-0" th:text="|R$ *{{subtotal}}|">R$ 0,00</h3></td>
                            </tr>
                            <tr>
                              <th class="lead form-inline">
                                Desconto
                                <select id="desconto" class="js-desconto custom-select ml-1 mr-sm-2" th:field="*{desconto}" 
                                  th:attr="data-url-base-desconto=@{/caixa/{venda}/desconto(venda=${venda.id})}">
                                  <option th:each="desconto : ${opcoesDescontoList}" th:value="${desconto}" th:text="${desconto.descricao}"></option>
                                </select>
                              </th>
                              <td id="desconto-valor"><p class="mb-0" th:text="|R$ *{{valorDesconto}}|">R$ 0,00</p></td>
                            </tr>
                            <tr>
                              <th class="lead">Total:</th>
                              <td id="total"><h3 class="mb-0" th:text="|R$ *{{total}}|"></h3></td>
                            </tr>
                            <tr>
                              <th class="lead">Saldo:</th>
                              <td>
                                <div class="input-group input-group-lg">
                                  <input type="text" class="js-currency form-control" id="inputSaldo" th:field="*{saldo}" th:classappend="${#fields.hasErrors('saldo')} ? 'is-invalid'"></input>
                                </div>
                              </td>
                            </tr>
                          </table>
                          <button type="submit" id="finalizar" class="btn btn-md btn-success">
                            <i class="far fa-credit-card"></i> 
                            Finalizar
                          </button>
                        </div>
                      </div>
                      
                      <div class="col-6">
                        <div style="border-style: none solid solid solid; border-width: 2px;border-color: #cbd3da; background-color: #fffed4">
                          <div class="chart">
                            <ul id="listaDeItens" data-widget="todo-list" class="items-list" style="height: 330px">
                              <li class="item" th:each="item, rowStat : *{itemList}">
                                  <input type="hidden" th:field="*{itemList[__${rowStat.index}__].id}"></input>
                                  <div class="row align-items-end">
                                      <div class="col-md-4 text-left">
                                        <h6><b id="descricao" th:text="${item.produto.descricao}"></b></h6>
                                        <h6 id="codigo" th:text="${item.produto.codigo}"></h6>
                                      </div>
                                      <div class="col-md-4 text-center">
                                          <h6 id="quantidade" th:text="|${item.quantidade} X ${{item.valor}}|"></h6>
                                        </div>
                                        <div class="col-md-4 text-right">
                                          <h5 th:text="${{item.valor}}"></h5>
                                      </div>
                                  </div>
                                </li>
                                <li class="linha border-bottom"></li>
                            </ul>
                          </div>
                        </div>
                      </div>
            
                    </div>
                    
                  </div>
                  <div class="card-footer py-0">
                  </div>
                  
                </div>
                <!-- /.card -->
              </div>
            </div>
          </div>
        </section>
      </form>
    </div>
  </section>
  
  <script layout:fragment="js-validator">
  	var currencyformatter = new Intl.NumberFormat('pt-BR', {
	  style: "currency",
	  currency: "BRL",
	  minimumFractionDigits: 2,
	  currencyDisplay: "symbol",
	});
  	
  	var decimalformatter = new Intl.NumberFormat('pt-BR', {
	  minimumFractionDigits: 2
	});
  	
 	// Execute a function when the user releases a key on the keyboard
  	$('#inputCodigoProduto').on('keyup', function(event) {
  	  // Number 13 is the "Enter" key on the keyboard
  	  if (event.keyCode === 13) {
  	    // Cancel the default action, if needed
  	    event.preventDefault();
  	    // Trigger the button element with a click
  	    $('.js-buscar-produto').click();
  	  }
  	});
  	
  	$('.js-desconto').on('change', function(event) {
  		event.preventDefault();
  		
  		var seletor = $(event.currentTarget);
		var url = seletor.data('url-base-desconto');
		var opcao = seletor.find('option:selected');
		var desconto = opcao[0].value;
		
		if(!url.endsWith('/')){
			url += '/';
		}
		
		url += desconto;
		
		console.log('URL: '+url);
		console.log('Desconto: '+desconto);
		
		var response = $.ajax({
			url: url,
			type: 'GET'
		});
  		
  		response.done(function(e){
  			$('#conteudo').replaceWith(e);
		});
		
		response.fail(function(e){
			alert('Erro aplicando desconto');
		});
  	});
  	
  	$('.js-finalizar').on('click', function(event) {

  		var saldo = $('#modalPagamento').find('input#inputSaldo').val();
  		saldo = parseFloat(saldo.replace(/\./g, '').replace(/,/, '.'));
  		console.log(saldo);
  		
  		var response = $.ajax({
			url: '/caixa/aplicar/saldo/'+saldo,
			type: 'PUT'
		});
  		
  		response.done(function(e){
  			$('#caixaForm').submit();
  		});
		
		response.fail(function(e){
			alert('Erro aplicando saldo');
		});
  	});
  </script>
    
</html>
