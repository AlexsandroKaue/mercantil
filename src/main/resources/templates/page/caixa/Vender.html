<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{principal}">
<head>
  <title th:text="#{mercadinho}"></title>
</head>

  <section layout:fragment="container">
    <form role="form"  method="POST" th:action="@{/caixa}" th:object="${caixa}">
      <!-- <header layout:insert="~{cabecalho}"></header> -->
      <div class="pt-2"></div>
      <header layout:insert="~{corpo}"></header>
    </form>
    
    <div class="modal" id="modalIncluirProduto">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label for="inputCodigoProduto" class="col-form-label">Produto</label>
                  <input id="inputCodigoProduto" type="text" autofocus="autofocus" class="form-control">
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
            <a th:href="@{/caixa/incluir/}" class="js-incluir btn btn-md btn-success" th:text="#{incluir}"></a>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal --> 
    
    <div class="modal" id="modalExcluirProduto">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"></h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label for="inputCodigoProduto" class="col-form-label">Produto</label>
                  <input id="inputCodigoProduto" type="text" autofocus="autofocus" class="form-control">
                </div>
              </div>
            </div>
          </div>
          
          <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
            <a th:href="@{/caixa/excluir/}" class="js-excluir btn btn-md btn-success" th:text="#{excluir}"></a>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal --> 
  </section>
  
  <!-- <section layout:fragment="cabecalho">
    <div class="col-md-9">
      <div class="bg-gray py-2 px-3 my-0 rounded" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
        <h1 class="text-center">
          Pronto para registrar
        </h1>
      </div>
    </div>
    <div class="col-md-3">
      <div class="bg-white py-2 px-3 my-0 rounded" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
        <h1 class="text-center">
          Pronto para registrar
        </h1>
      </div>
    </div>
  </section> -->
  
  <section layout:fragment="conteudo">
    <div class="card card-default">
      <!-- <div class="card-header"></div> -->
      <div class="card-body">
        <div class="row mb-2 align-items-center">
          <div class="col-md-9">
            <div class="bg-gray rounded" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
              <h1 id="descricaoProduto" class="text-center">
                Produto
              </h1>
            </div>
          </div>
          <!-- <div class="col-md-3 text-center">
            <div class="bg-white rounded py-1" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
              <div class="btn-lg btn-flat">
                <i class="fas fa-circle text-green"></i>
                Pronto para registrar
              </div>
            </div>
          </div> -->
          <!-- <div class="col-md-3 text-center">
            <div class="bg-white rounded py-1" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
              <div class="btn-lg btn-flat">
                <i class="fas fa-circle text-red"></i>
                Caixa fechado
              </div>
            </div>
          </div> -->
          <div class="col-md-3">
            <!-- <div class="bg-white rounded py-1" style="border-style: solid; border-width: 2px; border-color: #cbd3da;"> -->
              <div class="btn-lg btn-flat">
                <div class="row">
                  <div class="col-md-4 text-left">
                    Status:
                  </div>
                  <div class="col-md-8 text-right">
                    <i class="fas fa-circle text-yellow"></i>
                    Registrando
                  </div>
                </div>
              </div>
            <!-- </div> -->
          </div>
        </div>
      
        <div class="row" >
          
          <!-- <div class="col-md-3">
            <div class="progress-group">
              <h6>Código</h6>
              <div class="input-group">
              <input type="text" class="form-control" disabled="disabled"></input>
              <div class="input-group-append">
                <a data-toggle="modal" data-target="#modalIncluirProduto"
                 class="btn btn-block bg-gradient-success">
                  <i class="fas fa-plus"></i>
                </a>
              </div>
            </div>  
            </div>
            /.progress-group
            
            <div class="progress-group">
              <h6>Quantidade</h6>
              <input type="text"  class="form-control" disabled="disabled"></input>
            </div>
            /.progress-group
            
            <div class="progress-group">
              <h6>Preço Unitário</h6>
              <input type="text"  class="form-control" disabled="disabled"></input>
            </div>
            /.progress-group
            
            <div class="progress-group">
              <h6>Preço Total</h6>
              <input type="text" class="form-control" disabled="disabled"></input>
            </div>
            /.progress-group
            
            <div class="progress-group text-right">
              <h1 class="mt-3"><span class="text">Subtotal</span></h1>
              <div class="bg-gray py-2 px-3 ">
                <h1 id="subtotal" class="mb-0" style="font-family: 'Nimbus Sans Narrow', Times, monospace;">
                  R$ 0,00
                </h1>
              </div>
           </div>
           /.progress-group
          </div>
          /.col -->
                 
          <div class="col-md-9">
            <div class="bg-white py-2 px-2" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
              <ul class="items-list" style="height: 25px; margin-bottom: 0px">
                <li>
                  <div class="row">
                    <div class="col-md-5 text-left">
                      <h5 class="mb-0">
                        Descrição
                      </h5>
                    </div>
                    <div class="col-md-4 text-center">
                      <h5 class="mb-0">
                        Quantidade x Preço Unitário
                      </h5>
                    </div>
                    <div class="col-md-3 text-right">
                      <h5 class="mb-0">
                        Preço Total
                      </h5>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            
            <div style="border-style: none solid solid solid; border-width: 2px; 
            border-color: #cbd3da; background-color: #fffed4">
            
              <!-- <div class="box-profile">
                <div id="cupom"><pre th:text="${cupom}" style="height: 400px"></pre></div>
              </div> -->
              <div class="chart">
                <ul id="listaDeItens" data-widget="todo-list" class="items-list" style="height: 380px">
                 
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class=" text-center">
              <div class="btn btn-success btn-lg btn-flat btn-block py-2">
                <a data-toggle="modal" data-target="#modalIncluirProduto">
                  <i class="fas fa-plus fa-lg mr-2"></i>
                  Incluir
                </a>
              </div>
            </div>
            
            <div class=" text-right">
              <div class="btn btn-warning btn-lg btn-flat btn-block py-2 mt-2">
                <a data-toggle="modal" data-target="#modalExcluirProduto">
                  <i class="fas fa-minus-circle fa-lg mr-2"></i>
                  Remover
                </a>
              </div>
            </div>
          
           <div class=" text-right">
              <div class="btn btn-primary btn-lg btn-flat py-2 mt-2 btn-block">
                <!-- <i class="fas fa-cart-plus fa-lg mr-2"></i> -->
                <i class="fas fa-cart-plus fa-lg mr-2"></i> 
                Pagamento
              </div>
            </div>
            
            <div class=" text-right">
              <div class="btn btn-danger btn-lg btn-flat btn-block py-2 mt-2">
                <!-- <i class="fas fa-cart-plus fa-lg mr-2"></i> -->
                <i class="fas fa-cart-plus fa-lg mr-2"></i> 
                Cancelar
              </div>
            </div>
            
            <div class="progress-group text-right">
              <h1 style="margin-top: 107px;"><span class="text">Subtotal</span></h1>
              <div class="bg-gray py-2 px-3 ">
                <h1 id="subtotal" class="mb-0" style="font-family: 'Nimbus Sans Narrow', Times, monospace;">
                  R$ 0,00
                </h1>
              </div>
           </div>
           <!-- /.progress-group -->
          </div>
          
          </div>
        </div>
        <!-- /.row -->
        <div class="card-footer"></div>
      
    </div>
    <!-- /.card -->
  </section>
  
  <script layout:fragment="js-validator">

  	$('.js-incluir').on('click', function(event) {
		event.preventDefault();
		
		var botaoIncluir = $(event.currentTarget);
		var urlIncluirItem = botaoIncluir.attr('href');
		var codigoProduto = $('#modalIncluirProduto').find('input#inputCodigoProduto').val();
		urlIncluirItem += codigoProduto;
		
		var response = $.ajax({
			url: urlIncluirItem,
			type: 'GET'
		})
		
		response.done(function(e){
			var check = ''+
  			'<div  class="icheck-primary d-inline ml-2">'+
      			'<input type="checkbox" value="" name="todo4" id="todoCheck4"></input>'+
      			'<label for="todoCheck4"></label>'+
  			'</div>';
			
			atualizarLista(e.listaDeItem, e.item);
		});
		
		response.fail(function(e){
			console.log(e);
			alert('Erro incluindo item');
		});
		
		$('#modalIncluirProduto').modal("hide");
		
	});
  	
  	$('.js-excluir').on('click', function(event) {
		event.preventDefault();
		
		var botaoExcluir = $(event.currentTarget);
		var urlExcluirItem = botaoExcluir.attr('href');
		var codigoProduto = $('#modalExcluirProduto').find('input#inputCodigoProduto').val();
		urlExcluirItem += codigoProduto;
					
		var response = $.ajax({
			url: urlExcluirItem,
			type: 'GET'
		});
		
		response.done(function(e){
			var check = ''+
  			'<div  class="icheck-primary d-inline ml-2">'+
      			'<input type="checkbox" value="" name="todo4" id="todoCheck4"></input>'+
      			'<label for="todoCheck4"></label>'+
  			'</div>';
			
  			atualizarLista(e.listaDeItem, e.item);
		});
		
		response.fail(function(e){
			console.log(e);
			alert('Erro excluindo item');
		});
		
		$('#modalExcluirProduto').modal("hide");
		
	});
  	
  	function atualizarLista(listaDeItem, item) {
		// Create our number formatters.
		var currencyformatter = new Intl.NumberFormat('pt-BR', {
		  style: "currency",
		  currency: "BRL",
		  minimumFractionDigits: 2,
		  currencyDisplay: "symbol",
		});
		
		var decimalformatter = new Intl.NumberFormat('pt-BR', {
		  minimumFractionDigits: 2
		});
		
		var subtotal = 0.0;
		var li = '';
		for(var i=0; i<listaDeItem.length; i++) {
			li += '<li class="item"> '+
				'<div class="row align-items-end">'+
    				'<div class="col-md-5 text-left">'+
        				'<h5><b id="descricao">'+ listaDeItem[i].produto.descricao +'</b></h5>'+
        				'<h6 id="codigo">'+ listaDeItem[i].produto.codigo +'</h6>'+
    				'</div>'+
    				'<div class="col-md-4 text-center">'+
      					'<h5 id="quantidade">'+listaDeItem[i].quantidade+'un x '+ decimalformatter.format(listaDeItem[i].valor)+'</h5>'+
      				'</div>'+
      				'<div class="col-md-3 text-right">'+
      					'<h5>'+currencyformatter.format(listaDeItem[i].quantidade*listaDeItem[i].valor)+'</h5>'+
    				'</div>'+
				'</div>'+
			'</li>'+
			'<li class="linha border-bottom"></li>';
			subtotal += listaDeItem[i].valor*listaDeItem[i].quantidade;
		}
		$('#descricaoProduto').html(item.produto.descricao);
		$('#listaDeItens').html(li);
		$('#subtotal').html(currencyformatter.format(subtotal));
	}
  </script>
    
</html>
