<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{principal}">
<head>
  <title th:text="#{mercadinho}"></title>
</head>

  <section layout:fragment="container" th:fragment="container" id="containerSection">
    
    <section id="conteudoSection" layout:fragment="conteudo">
      <form id="caixaForm" role="form"  method="POST" th:action="@{/caixa/pagar}" th:object="${venda}">
        <div class="pt-2"></div>
        <!-- <div th:replace="corpo :: content"></div> -->
          <!-- <header layout:insert="~{corpo}"></header> -->

    <section class="content">
      <div class="container-fluid">
          <div layout:insert="~{mensagem_geral}"></div>
          <div layout:insert="~{mensagem_erro}"></div>
          <div class="row">
            <div class="col-md-12">
            <div class="card card-default">
              <!-- <div class="card-header"></div> -->
              <div class="card-body">
                <div class="row mb-2 align-items-center">
                  <div class="col-md-9">
                    <select class="js-example-data-ajax" style="width: 100%;"></select>
                  </div>
                  <div class="col-md-3 text-center">
                    
                  </div>
                </div>
              
                <div class="row" >
                         
                  <div class="col-md-9">
                    <div class="bg-white py-2 px-2" style="border-style: solid; border-width: 2px; border-color: #cbd3da;">
                      <ul class="items-list" style="height: 25px; margin-bottom: 0px">
                        <li>
                          <div class="row">
                            <div class="col-md-4 text-left">
                              <h5 class="lead mb-0">
                                Descrição
                              </h5>
                            </div>
                            <div class="col-md-4 text-center">
                              <h5 class="lead mb-0">
                                Quantidade x Preço Unitário
                              </h5>
                            </div>
                            <div class="col-md-3 text-right">
                              <h5 class="lead mb-0">
                                Preço Total
                              </h5>
                            </div>
                            <div class="col-md-1"></div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    
                    <div style="border-style: none solid solid solid; border-width: 2px;border-color: #cbd3da; background-color: #fffed4">
                      <div class="chart">
                        <ul id="listaDeItens" data-widget="todo-list" class="items-list" style="height: 330px">
                          <th:block th:each="item : *{itemList}">
                              <li class="item">
                              <div class="row align-items-end">
                               <div class="col-md-4 text-left">
                                  <h6><b id="descricao" th:text="${item.produto.descricao}"></b></h6>
                                  <h6 id="codigo" th:text="${item.produto.codigo}"></h6>
                               </div>
                              <div class="col-md-4 text-center">
                                 <h6 id="quantidade" th:text="|${item.quantidade}un x ${{item.valor}}|"></h6>
                              </div>
                              <div class="col-md-3 text-right">
                                 <h5 th:text="|R$ ${item.quantidade*item.valor}|"></h5>
                              </div>
                              <div class="col-md-1 text-center">
                                <h6>
                                 <a data-toggle="modal" data-target="#modalConfirmarRemocaoItem" class="text-muted btn-sm"
                                  th:attr="data-codigo=${item.produto.codigo}, data-descricao=${item.produto.descricao}"
                                  title="Excluir" rel="tooltip" data-placement="top"><!--  -->
                                  <i class="fas fa-trash"></i>
                                </a>
                                </h6>
                              </div>
                              </div>
                            </li>
                            <li class="linha border-bottom">
                            </li>
                          </th:block>
                        </ul>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-3 align-self-end">
                    <div class=" text-center">
                      <div class="btn btn-info btn-flat btn-block py-2">
                        <a data-toggle="modal" data-target="#modalEscolherCliente">
                          <i class="fas fa-user fa-lg mr-2"></i>
                          Selecionar usuário
                        </a>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-12">
                        <div class=" text-right">
                          <button type="submit" class="btn btn-primary btn-flat py-2 btn-block">
                            <i class="fas fa-cart-plus mr-2"></i>
                            Pagamento
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-12">
                        <div class=" text-right">
                          <div class="btn btn-danger btn-flat btn-block py-2">
                            <i class="fas fa-cart-arrow-down mr-2"></i> 
                            Cancelar
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="progress-group text-right">
                      <h2><span class="text">Subtotal</span></h2>
                      <div class="bg-gray py-2 px-3 ">
                        <input type="hidden" th:field="*{subtotal}"></input>
                        <h2 id="subtotal" th:text="|R$ *{{subtotal}}|" 
                          class="js-subtotal mb-0" 
                          style="font-family: 'Nimbus Sans Narrow', Times, monospace;">
                        </h2>
                      </div>
                   </div>
                   <!-- /.progress-group -->
                  </div>
                  
                  </div>
                </div>
                <!-- /.row -->
                <div class="card-footer py-0">
                  <div class="row">
                    <div class="col-sm-3 col-6">
                      <div class="description-block border-right">
                        <!-- <span class="description-percentage text-success"><i class="fas fa-caret-up"></i> 17%</span> -->
                        <h5 class="description-header">Cliente</h5>
                        <span class="description-text">Fernanda Araújo</span>
                      </div>
                      <!-- /.description-block -->
                    </div>
                    <!-- /.col -->
                    <div class="col-sm-3 col-6">
                      <div class="description-block border-right">
                        <!-- <span class="description-p0ercentage text-warning"><i class="fas fa-caret-left"></i> 0%</span>
                        <h5 class="description-header">$10,390.90</h5> -->
                      </div>
                      <!-- /.description-block -->
                    </div>
                    <!-- /.col -->
                    <div class="col-sm-3 col-6">
                      <div class="description-block border-right">
                        <span class="description-percentage text-success"><i class="fas fa-caret-up"></i> 20%</span>
                        <h5 class="description-header">$24,813.53</h5>
                      </div>
                      <!-- /.description-block -->
                    </div>
                    <!-- /.col -->
                    <div class="col-sm-3 col-6">
                      <div class="description-block">
                        <h5 class="description-header">Status</h5>
                        <span class="description-text">
                          <i class="fas fa-circle text-yellow"></i>
                          Registrando
                        </span>
                      </div>
                      <!-- /.description-block -->
                    </div>
                  </div>
                  <!-- /.row -->
                </div>
              
            </div>
            <!-- /.card -->
            </div>
          </div>
        </div>
       </section>
      </form>
     </section> 
    
    <div class="modal" id="modalEscolherCliente">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">
              Clientes
            </h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          
          <div class="modal-body">
            <div class="row d-flex align-items-stretch">
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>Marcos Novaes</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user1-128x128.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Endereço: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Telefone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>José Alves</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user2-160x160.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Address: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Phone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>Fernanda Araújo</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user4-128x128.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Endereço: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Telefone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>Marcos Novaes</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user1-128x128.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Endereço: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Telefone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>José Alves</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user2-160x160.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Address: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Phone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-sm-6 col-md-4 d-flex align-items-stretch">
                <div class="card bg-light">
                  <div class="card-header text-muted border-bottom-0"></div>
                  <div class="card-body pt-0">
                    <div class="row">
                      <div class="col-7">
                        <h2 class="lead"><b>Fernanda Araújo</b></h2>
                      </div>
                      <div class="col-5 text-center">
                        <img th:src="@{/dist/img/user4-128x128.jpg}" alt="" class="img-circle img-fluid"></img>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-12">
                        <!-- <p class="text-muted text-sm"><b>Sobre: </b> Web Designer / UX / Graphic Artist / Coffee Lover </p> -->
                        <ul class="ml-4 mb-0 fa-ul text-muted">
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-building"></i></span> Endereço: Demo Street 123, Demo City 04312, NJ</li>
                          <li class="small"><span class="fa-li"><i class="fas fa-lg fa-phone"></i></span> Telefone #: + 800 - 12 12 23 52</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="card-footer">
                    <div class="text-right">
                      <a href="#" class="btn btn-sm bg-teal">
                        <i class="fas fa-comments"></i>
                      </a>
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-user"></i> Selecionar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          
          <div class="card-footer">
            <nav aria-label="Contacts Page Navigation">
              <ul class="pagination justify-content-center m-0">
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item"><a class="page-link" href="#">6</a></li>
                <li class="page-item"><a class="page-link" href="#">7</a></li>
                <li class="page-item"><a class="page-link" href="#">8</a></li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  
    <div class="modal fade" id="modalConfirmarRemocaoItem" tabindex="-1" data-keyboard="false" data-backdrop="static">
      <div class="modal-dialog">
        <!-- <form th:attr="data-url-base=@{/titulos}" method="POST"> -->
          <input type="hidden" name="_method" value="DELETE"></input>
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Default Modal</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>Deseja realmente excluir o título?</p>
            </div>
            <div class="modal-footer justify-content-between">
             <button type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
             <a th:attr="data-url-base=@{/caixa/excluir/}" class="js-remover btn btn-md btn-success" th:text="#{excluir}"></a>
            </div>
          </div>
          <!-- /.modal-content -->
        <!-- </form> -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    
  </section>
  
  <script layout:fragment="js-validator">
  	var currencyformatter = new Intl.NumberFormat('pt-BR', {
	  style: "currency",
	  currency: "BRL",
	  minimumFractionDigits: 2,
	  currencyDisplay: "symbol",
	});
  	
  	var decimalformatter = new Intl.NumberFormat('pt-BR', {
	  minimumFractionDigits: 2
	});
  	
 	// Execute a function when the user releases a key on the keyboard
  	$('#container').on('keyup', '#inputCodigoProduto', function(event) {
  	  // Number 13 is the "Enter" key on the keyboard
  	  if (event.keyCode === 13) {
  	    // Cancel the default action, if needed
  	    event.preventDefault();
  	    // Trigger the button element with a click
  	    $('.js-buscar-produto').click();
  	  }
  	});  	
  	
    $("#container").ready(function() {
    	$('.js-example-data-ajax').click();
    });
  	
  	$("#container").on("click", ".js-example-data-ajax", function(){
  		$(this).select2({
  	      language: "pt-BR",
    	  ajax: {
    	    url: "/caixa/buscarProdutoAjax",
    	    dataType: 'json',
    	    delay: 250,
    	    data: function (params) {
    	      return {
    	        q: params.term, // search term
    	        page: params.page || 1 
    	      };
    	    },
    	    processResults: function (data, params) {
    	      // parse the results into the format expected by Select2
    	      // since we are using custom formatting functions we do not need to
    	      // alter the remote JSON data, except to indicate that infinite
    	      // scrolling can be used
    	      params.page = params.page || 1;
  
    	      return {
    	        results: data.items,
    	        pagination: {
    	          more: (params.page * data.page_size) < data.total_count
    	        }
    	      };
    	    },
    	    cache: true
    	  },
    	  placeholder: 'Procure por um produto',
    	  minimumInputLength: 1,
    	  templateResult: formatRepo,
    	  templateSelection: formatRepoSelection
    	});
  		
  	});
  	
    

  	function formatRepo (repo) {
  	  if (repo.loading) {
  	    return repo.text;
  	  }

  	  var $container = $(
  	    "<div class='select2-result-repository clearfix'>" +
  	      "<div class='select2-result-repository__avatar'><img src='/custom/img/sem-imagem_3.png'/></div>" +
  	      "<div class='select2-result-repository__meta'>" +
  	      	"<div class='select2-result-repository__description'></div>" +
  	        "<div class='select2-result-repository__title'></div>" +
  	        /* "<div class='select2-result-repository__statistics'>" +
  	          "<div class='select2-result-repository__forks'><i class='fa fa-flash'></i> </div>" +
  	          "<div class='select2-result-repository__stargazers'><i class='fa fa-star'></i> </div>" +
  	          "<div class='select2-result-repository__watchers'><i class='fa fa-eye'></i> </div>" +
  	        "</div>" + */
  	      "</div>" +
  	    "</div>"
  	  );

  	  $container.find(".select2-result-repository__description").text(repo.codigo);
  	  $container.find(".select2-result-repository__title").text(repo.descricao);
  	  /* $container.find(".select2-result-repository__forks").append(123 + " Forks");
  	  $container.find(".select2-result-repository__stargazers").append(123 + " Stars");
  	  $container.find(".select2-result-repository__watchers").append(123 + " Watchers"); */

  	  return $container;
  	}

  	function formatRepoSelection (repo) {
  	  return repo.full_name || repo.text;
  	}
    
    $('#container').on('select2:select','.js-example-data-ajax', function (e) {
        var data = e.params.data;
        var response = $.ajax({
			url: '/caixa/incluir/'+data.codigo,
			type: 'GET'
		});
		
		response.done(function(e){
			console.log(e);
			var html = $.parseHTML(e);
			$('#conteudoSection').replaceWith(html);
			$('.js-example-data-ajax').click();
		});
		
		response.fail(function(e){
			alert('Erro incluindo item');
		});
    });
    

    
	$('#container').on('show.bs.modal', '#modalConfirmarRemocaoItem', function(event){
    	var button = $(event.relatedTarget); // Button that triggered the modal
    	var codigo = button.data('codigo'); // Extract info from data-* attributes
    	var descricao = button.data('descricao');
    	var modal = $(this);
    	var a = modal.find('a.js-remover');
    	var url = a.data('url-base');
    	
    	if(!url.endsWith('/')){
    		url += '/';
    	}
    	
    	a.attr('href',url + codigo);
    	modal.find('.modal-body p').html('Deseja realmente excluir o item <strong>'+descricao+'</strong> da lista?');    	
    });
	
	$('#container').on('click', '.js-remover', function(event) {
  		event.preventDefault();
		
		var botaoExcluir = $(event.currentTarget);

		var urlExcluirItem = botaoExcluir.attr('href');

		var response = $.ajax({
			url: urlExcluirItem,
			type: 'GET'
		});
		
		response.done(function(e){
			$('#conteudoSection').html(e);
			console.log(e);
			//$('#modalConfirmarRemocaoItem').modal('hide');
		});
		
		response.fail(function(e){
			alert('Erro excluindo item');
		});
		
	});
  </script>
    
</html>
